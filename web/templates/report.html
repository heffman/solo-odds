<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Solo Odds Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/site.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-body">
  <div class="container container-narrow py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3 mb-0">Solo Odds Report</h1>
      <div class="d-flex gap-3">
        <a href="/" class="link-secondary">New report</a>
        <a href="/methods" class="link-secondary">Methods</a>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex flex-column gap-2">

          <div class="d-flex flex-wrap align-items-center gap-2">
            <strong class="me-1">Share link:</strong>
            <span class="share-box flex-grow-1">
              <a href="/r/{{ token }}">/r/{{ token }}</a>
            </span>
            <button id="copy-link" type="button" class="btn btn-outline-secondary btn-sm">Copy</button>
            <span id="copy-status" class="text-body-secondary small"></span>
          </div>

          <div class="d-flex flex-wrap align-items-center gap-2">
            <strong class="me-1">JSON API:</strong>
            <span class="share-box flex-grow-1">
              <a href="{{ api_url }}">{{ api_url }}</a>
            </span>
          </div>

          <div class="text-body-secondary small">
            Snapshot frozen at: {{ report.network_snapshot.timestamp }}
          </div>
        </div>
      </div>
    </div>

    <!-- Inputs summary -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">Coin</div>
            <div class="fw-semibold">{{ report.input.coin|upper }}</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">Hashrate</div>
            <div class="fw-semibold">{{ report.input.hashrate_display }}</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">Horizon</div>
            <div class="fw-semibold">{{ report.input.horizon_days }} days</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">Drift</div>
            <div class="fw-semibold">{{ report.input.drift_model.type }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytic -->
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h5 mb-3">Analytic</h2>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">Expected blocks (μ)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.expected_blocks) }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">P(≥1 block)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.probability_at_least_one) }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">P(0 blocks)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.probability_zero_blocks) }}</div>
          </div>

          <!-- Time-to-first: show mean vs median side-by-side -->
          <div class="col-12">
            <div class="text-body-secondary small">Time to first block (days)</div>
            <div class="d-flex flex-wrap gap-3">
              <div>
                <span class="text-body-secondary small">Median (T₁ p50):</span>
                <span class="fw-semibold ms-1">{{ "%.6g"|format(report.analytic.time_to_first_block_median_days) }}</span>
              </div>
              <div>
                <span class="text-body-secondary small">Mean:</span>
                <span class="fw-semibold ms-1">{{ "%.6g"|format(report.analytic.time_to_first_block_mean_days) }}</span>
              </div>
            </div>
          </div>

          <div class="mt-2 text-body-secondary small">
            50% probability of first block by
            <strong>{{ "%.6g"|format(report.analytic.time_to_first_block_median_days) }} days</strong>;
            mean waiting time
            <strong>{{ "%.6g"|format(report.analytic.time_to_first_block_mean_days) }} days</strong>.
          </div>

          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">T₁ p10 (days)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.time_to_first_block_days.p10) }}</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">T₁ p50 (days)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.time_to_first_block_days.p50) }}</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">T₁ p90 (days)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.time_to_first_block_days.p90) }}</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">T₁ mean (legacy)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.time_to_first_block_days.mean) }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Curve -->
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h5 mb-3">Curve: P(≥1 block) vs days (with T₁ p10–p90 band)</h2>
        <div class="chart-wrap">
          <canvas id="curve"></canvas>
        </div>
        <div class="text-body-secondary small mt-2">
          Baseline is analytic. Reinvestment overlay (if enabled) is Monte Carlo.
        </div>
      </div>
    </div>

    <div class="text-body-secondary small mt-2">
      Shaded region shows the analytic time-to-first-block window: p10 to p90. Line marks p50.
    </div>

    <!-- Monte Carlo summary -->
    {% if report.monte_carlo.enabled %}
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h5 mb-3">Monte Carlo</h2>

        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
          <strong>Runs:</strong> <span>{{ report.monte_carlo.runs }}</span>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">Mean blocks</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.monte_carlo.blocks_over_horizon.mean) }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">P(≥1)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.monte_carlo.blocks_over_horizon.probability_at_least_one) }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">P(0)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.monte_carlo.blocks_over_horizon.probability_zero) }}</div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Reinvest summary -->
    {% if reinvest and reinvest.enabled %}
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h5 mb-2">Reinvestment scenario</h2>
        <div class="row g-3">
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">Multiplier</div>
            <div class="fw-semibold">{{ reinvest.multiplier }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">Monte Carlo runs</div>
            <div class="fw-semibold">{{ reinvest.runs }}</div>
          </div>
        </div>
        <p class="text-body-secondary small mt-2 mb-0">
          Assumes hashrate increases immediately after the first block is found.
        </p>
      </div>
    </div>
    {% endif %}

    <!-- Snapshot -->
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h5 mb-3">Network snapshot</h2>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <tbody>
              <tr><th scope="row" class="text-body-secondary">timestamp</th><td>{{ report.network_snapshot.timestamp }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">network_hashrate_hs</th><td>{{ report.network_snapshot.network_hashrate_hs }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">difficulty</th><td>{{ report.network_snapshot.difficulty }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">blocks_per_day</th><td>{{ report.network_snapshot.blocks_per_day }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">block_reward</th><td>{{ report.network_snapshot.block_reward }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">source</th><td>{{ report.network_snapshot.source }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">source_url</th><td>{{ report.network_snapshot.source_url }}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <script>
    (function () {
      const canvas = document.getElementById('curve');
      if (!canvas) return;

      const points = {{ curve|tojson }};
      if (!points || points.length === 0) return;

      const labels = points.map(p => p.day);
      const pAtLeastOne = points.map(p => p.probability_at_least_one);

      const datasets = [{
        label: 'P(≥1 block) (analytic)',
        data: pAtLeastOne,
        tension: 0.2,
        pointRadius: 0
      }];

      {% if reinvest and reinvest.enabled %}
      const reinvestPoints = {{ reinvest.points|tojson }};
      if (reinvestPoints && reinvestPoints.length > 0) {
        datasets.push({
          label: 'Reinvest after first block (MC) — P(≥1)',
          data: reinvestPoints.map(p => p.probability_at_least_one),
          tension: 0.2,
          pointRadius: 0
        });
      }
      {% endif %}

       // Time-to-first band markers (days). These come from your analytic block.
      const t10 = Number({{ report.analytic.time_to_first_block_days.p10|tojson }});
      const t50 = Number({{ report.analytic.time_to_first_block_days.p50|tojson }});
      const t90 = Number({{ report.analytic.time_to_first_block_days.p90|tojson }});

      // Custom plugin to draw a vertical shaded band [t10, t90] and a line at t50.
      // No external dependencies.
      const t1BandPlugin = {
        id: 't1BandPlugin',
        afterDatasetsDraw(chart) {
          if (!Number.isFinite(t10) || !Number.isFinite(t90)) return;
          const { ctx, chartArea, scales } = chart;
          const xScale = scales.x;
          if (!xScale || !chartArea) return;

          // Convert "days" values to pixel positions.
          // x scale is category by labels. We'll map day->index by nearest label.
          const dayToIndex = (day) => {
            // labels are numbers; find nearest index
            let bestIdx = 0;
            let bestDist = Infinity;
            for (let i = 0; i < labels.length; i++) {
              const d = Math.abs(Number(labels[i]) - day);
              if (d < bestDist) { bestDist = d; bestIdx = i; }
            }
            return bestIdx;
          };

          const i10 = dayToIndex(t10);
          const i90 = dayToIndex(t90);
          const i50 = Number.isFinite(t50) ? dayToIndex(t50) : null;

          const x10 = xScale.getPixelForValue(i10);
          const x90 = xScale.getPixelForValue(i90);

          ctx.save();

          // Shaded region
          ctx.globalAlpha = 0.12;
          ctx.fillRect(
            Math.min(x10, x90),
            chartArea.top,
            Math.abs(x90 - x10),
            chartArea.bottom - chartArea.top
          );

          // Outline (optional subtle)
          ctx.globalAlpha = 0.25;
          ctx.strokeRect(
            Math.min(x10, x90),
            chartArea.top,
            Math.abs(x90 - x10),
            chartArea.bottom - chartArea.top
          );

          // Median line
          if (i50 !== null) {
            const x50 = xScale.getPixelForValue(i50);
            ctx.globalAlpha = 0.5;
            ctx.beginPath();
            ctx.moveTo(x50, chartArea.top);
            ctx.lineTo(x50, chartArea.bottom);
            ctx.stroke();
          }

          ctx.restore();
        }
      };

      if (window.__soloOddsCurveChart) {
        window.__soloOddsCurveChart.destroy();
        window.__soloOddsCurveChart = null;
      }

      window.__soloOddsCurveChart = new Chart(canvas, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          scales: {
            y: {
              title: { display: true, text: 'P(≥1 block)' },
              min: 0,
              max: 1
            },
            x: {
              title: { display: true, text: 'Days' }
            }
          },
          plugins: {
            legend: { display: true }
          }
        },
        plugins: [t1BandPlugin]
      });

      const btn = document.getElementById('copy-link');
      const status = document.getElementById('copy-status');
      if (btn) {
        btn.addEventListener('click', async () => {
          const url = `${window.location.origin}/r/{{ token }}`;
          try {
            await navigator.clipboard.writeText(url);
            if (status) {
              status.textContent = 'Copied.';
              setTimeout(() => { status.textContent = ''; }, 1500);
            }
          } catch (e) {
            window.prompt('Copy this link:', url);
          }
        });
      }
    })();
  </script>
</body>
</html>