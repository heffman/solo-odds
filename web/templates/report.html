<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Solo Odds Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/site.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-body">
  <div class="container container-narrow py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3 mb-0">Solo Odds Report</h1>
      <div class="d-flex gap-3">
        <a href="/" class="link-secondary">New report</a>
        <a href="/methods" class="link-secondary">Methods</a>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex flex-column gap-2">

          <div class="d-flex flex-wrap align-items-center gap-2">
            <strong class="me-1">Share link:</strong>
            <span class="share-box flex-grow-1">
              <a href="/r/{{ token }}">/r/{{ token }}</a>
            </span>
            <button id="copy-link" type="button" class="btn btn-outline-secondary btn-sm">Copy</button>
            <span id="copy-status" class="text-body-secondary small"></span>
          </div>

          <div class="d-flex flex-wrap align-items-center gap-2">
            <strong class="me-1">JSON API:</strong>
            <span class="share-box flex-grow-1">
              <a href="{{ api_url }}">{{ api_url }}</a>
            </span>
          </div>

          <div class="text-body-secondary small">
            Snapshot frozen at: {{ report.network_snapshot.timestamp }}
          </div>
        </div>
      </div>
    </div>

    <!-- Inputs summary -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">Coin</div>
            <div class="fw-semibold">{{ report.input.coin|upper }}</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">Hashrate</div>
            <div class="fw-semibold">{{ report.input.hashrate_display }}</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">Horizon</div>
            <div class="fw-semibold">{{ report.input.horizon_days }} days</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">Drift</div>
            <div class="fw-semibold">{{ report.input.drift_model.type }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytic -->
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h5 mb-3">Analytic</h2>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">Expected blocks (μ)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.expected_blocks) }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">P(≥1 block)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.probability_at_least_one) }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">P(0 blocks)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.probability_zero_blocks) }}</div>
          </div>

          <!-- Time-to-first: show mean vs median side-by-side -->
          <div class="col-12">
            <div class="text-body-secondary small">Time to first block (days)</div>
            <div class="d-flex flex-wrap gap-3">
              <div>
                <span class="text-body-secondary small">Median (T₁ p50):</span>
                <span class="fw-semibold ms-1">{{ "%.6g"|format(report.analytic.time_to_first_block_median_days) }}</span>
              </div>
              <div>
                <span class="text-body-secondary small">Mean:</span>
                <span class="fw-semibold ms-1">{{ "%.6g"|format(report.analytic.time_to_first_block_mean_days) }}</span>
              </div>
            </div>
          </div>

          <div class="mt-2 text-body-secondary small">
            50% probability of first block by
            <strong>{{ "%.6g"|format(report.analytic.time_to_first_block_median_days) }} days</strong>;
            mean waiting time
            <strong>{{ "%.6g"|format(report.analytic.time_to_first_block_mean_days) }} days</strong>.
          </div>

          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">T₁ p10 (days)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.time_to_first_block_days.p10) }}</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">T₁ p50 (days)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.time_to_first_block_days.p50) }}</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">T₁ p90 (days)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.time_to_first_block_days.p90) }}</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-body-secondary small">T₁ mean (legacy)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.analytic.time_to_first_block_days.mean) }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Curve -->
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h5 mb-3">Curve: P(≥1 block) vs days (with T₁ p10–p90 band)</h2>
        <div class="chart-wrap">
          <canvas id="curve"></canvas>
        </div>
        <div class="text-body-secondary small mt-2">
          Baseline is analytic. Reinvestment overlay (if enabled) is Monte Carlo.
        </div>
      </div>
    </div>

    <div class="text-body-secondary small mt-2">
      Shaded region shows the analytic time-to-first-block window: p10 to p90. Line marks p50.
    </div>

    <!-- Monte Carlo summary -->
    {% if report.monte_carlo.enabled %}
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h5 mb-3">Monte Carlo</h2>

        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
          <strong>Runs:</strong> <span>{{ report.monte_carlo.runs }}</span>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">Mean blocks</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.monte_carlo.blocks_over_horizon.mean) }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">P(≥1)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.monte_carlo.blocks_over_horizon.probability_at_least_one) }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">P(0)</div>
            <div class="fw-semibold">{{ "%.6g"|format(report.monte_carlo.blocks_over_horizon.probability_zero) }}</div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Reinvest summary -->
    {% if reinvest and reinvest.enabled %}
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h5 mb-2">Reinvestment scenario</h2>
        <div class="row g-3">
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">Multiplier</div>
            <div class="fw-semibold">{{ reinvest.multiplier }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-body-secondary small">Monte Carlo runs</div>
            <div class="fw-semibold">{{ reinvest.runs }}</div>
          </div>
        </div>
        <p class="text-body-secondary small mt-2 mb-0">
          Assumes hashrate increases immediately after the first block is found.
        </p>
      </div>
    </div>
    {% endif %}

    <!-- Snapshot -->
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h5 mb-3">Network snapshot</h2>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <tbody>
              <tr><th scope="row" class="text-body-secondary">timestamp</th><td>{{ report.network_snapshot.timestamp }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">network_hashrate_hs</th><td>{{ report.network_snapshot.network_hashrate_hs }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">difficulty</th><td>{{ report.network_snapshot.difficulty }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">blocks_per_day</th><td>{{ report.network_snapshot.blocks_per_day }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">block_reward</th><td>{{ report.network_snapshot.block_reward }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">source</th><td>{{ report.network_snapshot.source }}</td></tr>
              <tr><th scope="row" class="text-body-secondary">source_url</th><td>{{ report.network_snapshot.source_url }}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<script>
  (function () {
    const canvas = document.getElementById('curve');
    if (!canvas) return;

    const points = {{ curve|tojson }};
    if (!points || points.length === 0) return;

    // Build XY points so x-axis is numeric days (linear), not categories.
    const baselineSeries = points.map(p => ({
      x: Number(p.day),
      y: Number(p.probability_at_least_one),
    }));

    const datasets = [{
      label: 'P(≥1 block) (analytic)',
      data: baselineSeries,
      tension: 0.2,
      pointRadius: 0
    }];

    {% if reinvest and reinvest.enabled %}
    const reinvestPoints = {{ reinvest.points|tojson }};
    if (reinvestPoints && reinvestPoints.length > 0) {
      datasets.push({
        label: 'Reinvest after first block (MC) — P(≥1)',
        data: reinvestPoints.map(p => ({ x: Number(p.day), y: Number(p.probability_at_least_one) })),
        tension: 0.2,
        pointRadius: 0
      });
    }
    {% endif %}

    let t10 = Number({{ report.analytic.time_to_first_block_days.p10|tojson }});
    let t50 = Number({{ report.analytic.time_to_first_block_days.p50|tojson }});
    let t90 = Number({{ report.analytic.time_to_first_block_days.p90|tojson }});

    // Clamp band to plotted x-range so it doesn't "cover everything" when out of range.
    const xMin = Math.min(...baselineSeries.map(p => p.x));
    const xMax = Math.max(...baselineSeries.map(p => p.x));

    const clamp = (v) => Math.min(xMax, Math.max(xMin, v));
    const t10c = Number.isFinite(t10) ? clamp(t10) : null;
    const t90c = Number.isFinite(t90) ? clamp(t90) : null;
    const t50c = Number.isFinite(t50) ? clamp(t50) : null;

    const t1BandPlugin = {
      id: 't1BandPlugin',
      afterDatasetsDraw(chart) {
        if (t10c === null || t90c === null) return;

        const { ctx, chartArea, scales } = chart;
        const xScale = scales.x;
        if (!xScale || !chartArea) return;

        const x10 = xScale.getPixelForValue(t10c);
        const x90 = xScale.getPixelForValue(t90c);

        ctx.save();

        // Make it visible and consistent (Bootstrap "primary" hue).
        ctx.fillStyle = 'rgba(13,110,253,0.12)';
        ctx.strokeStyle = 'rgba(13,110,253,0.35)';

        const left = Math.min(x10, x90);
        const width = Math.abs(x90 - x10);

        ctx.fillRect(left, chartArea.top, width, chartArea.bottom - chartArea.top);
        ctx.strokeRect(left, chartArea.top, width, chartArea.bottom - chartArea.top);

        if (t50c !== null) {
          const x50 = xScale.getPixelForValue(t50c);
          ctx.strokeStyle = 'rgba(13,110,253,0.7)';
          ctx.beginPath();
          ctx.moveTo(x50, chartArea.top);
          ctx.lineTo(x50, chartArea.bottom);
          ctx.stroke();
        }

        ctx.restore();
      }
    };

    if (window.__soloOddsCurveChart) {
      window.__soloOddsCurveChart.destroy();
      window.__soloOddsCurveChart = null;
    }

    window.__soloOddsCurveChart = new Chart(canvas, {
      type: 'line',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        parsing: false,
        scales: {
          x: {
            type: 'linear',
            title: { display: true, text: 'Days' },
            min: xMin,
            max: xMax
          },
          y: {
            title: { display: true, text: 'P(≥1 block)' },
            min: 0,
            max: 1
          }
        },
        plugins: { legend: { display: true } }
      },
      plugins: [t1BandPlugin]
    });
  })();
</script>
</body>
</html>