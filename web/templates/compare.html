<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Solo vs Pool Comparison</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/site.css?v=2.1">
</head>
<body class="bg-body">
  <div class="container container-narrow py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3 mb-0">Solo vs Pool Risk Comparison</h1>
      <div class="d-flex gap-3">
        <a href="/" class="link-secondary">Home</a>
        <a href="/methods" class="link-secondary">Methods</a>
      </div>
    </div>

    <div class="card p-3 mb-4">
      <form id="compare-form">
        <div class="row g-3">

          <div class="col-md-4">
            <label class="form-label">Coin</label>
            <select name="coin" class="form-select">
              <option value="btc" {% if (not token_mode and defaults.coin == 'btc') %}selected{% endif %}>BTC</option>
              <option value="bch" {% if (token_mode) or (not token_mode and defaults.coin == 'bch') %}selected{% endif %}>BCH</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Hashrate</label>
            <input name="hashrate" class="form-control" value="{% if token_mode %}{{ result.input.hashrate_display }}{% else %}{{ defaults.hashrate }}{% endif %}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Horizon (days)</label>
            <input name="horizon_days" type="number" class="form-control" value="{% if token_mode %}{{ result.input.horizon_days }}{% else %}{{ defaults.horizon_days }}{% endif %}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Coin price (USD)</label>
            <input name="coin_price_usd" type="number" step="0.01" class="form-control" value="{% if token_mode %}{{ result.input.coin_price_usd }}{% else %}{{ defaults.coin_price_usd }}{% endif %}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Electricity cost ($/kWh)</label>
            <input name="electricity_cost_per_kwh" type="number" step="0.001" class="form-control" value="{% if token_mode %}{{ result.input.electricity_cost_per_kwh }}{% else %}{{ defaults.electricity_cost_per_kwh }}{% endif %}">
          </div>

          <div class="col-md-4">
            <label class="form-label">ASIC power (watts)</label>
            <input name="asic_power_watts" type="number" class="form-control" value="{% if token_mode %}{{ result.input.asic_power_watts }}{% else %}{{ defaults.asic_power_watts }}{% endif %}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Pool fee (fraction)</label>
            <input name="pool_fee_pct" type="number" step="0.001" class="form-control" value="{% if token_mode %}{{ result.input.pool_fee_pct }}{% else %}{{ defaults.pool_fee_pct }}{% endif %}">
            <div class="form-text">Example: 0.02 = 2%</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Monte Carlo runs</label>
            <input name="mc_runs" type="number" class="form-control" value="{% if token_mode %}{{ result.input.mc_runs }}{% else %}{{ defaults.mc_runs }}{% endif %}">
            <div class="form-text">Reserved for later (not used in v1 compare math yet).</div>
          </div>

        </div>

        <div class="mt-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary" {% if token_mode %}disabled{% endif %}>Compare</button>

          <button id="share-btn" type="button" class="btn btn-outline-secondary" disabled>
            Copy share link
          </button>
        </div>

        <div class="mt-2 small text-body-secondary" id="share-status"></div>
      </form>
    </div>

    <div id="results" style="display:none;">
      <div class="alert alert-warning fw-semibold" id="regret-alert"></div>

      <div class="row g-3">
        <div class="col-md-6">
          <div class="card p-3">
            <h2 class="h6">Solo</h2>
            <div id="solo-results"></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card p-3">
            <h2 class="h6">Pool</h2>
            <div id="pool-results"></div>
          </div>
        </div>
      </div>
    </div>

    {% if token_mode %}
    <div class="card p-3 mt-3">
      <div class="d-flex flex-wrap align-items-center gap-2">
        <strong>Share link:</strong>
        <span class="share-box flex-grow-1">
          <a href="/c/{{ token }}">/c/{{ token }}</a>
        </span>
        <button id="copy-existing" class="btn btn-outline-secondary btn-sm" type="button">Copy</button>
        <span id="copy-existing-status" class="small text-body-secondary"></span>
      </div>
    </div>
    {% endif %}

  </div>

<script>
(function () {
  const form = document.getElementById('compare-form');
  const resultsEl = document.getElementById('results');
  const shareBtn = document.getElementById('share-btn');
  const shareStatus = document.getElementById('share-status');

 function normalizeHashrate(s) {
    // Keep it simple: trim, remove internal spaces, uppercase units.
    // Examples: "9.4 th" -> "9.4TH", " 500 gh/s " -> "500GH/S"
    if (s == null) return '';
    return String(s).trim().replace(/\s+/g, '').toUpperCase();
  }

  function toPayload() {
    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());

    // Normalize string fields
    payload.coin = String(payload.coin || '').trim().toLowerCase();
    payload.hashrate = normalizeHashrate(payload.hashrate);

    // Normalize numeric fields
    payload.horizon_days = Number(payload.horizon_days);
    payload.coin_price_usd = Number(payload.coin_price_usd);
    payload.electricity_cost_per_kwh = Number(payload.electricity_cost_per_kwh);
    payload.asic_power_watts = Number(payload.asic_power_watts);
    payload.pool_fee_pct = Number(payload.pool_fee_pct);
    payload.mc_runs = Number(payload.mc_runs);

    return payload;
  }

  function render(data) {
    const regret = data.comparison.probability_solo_underperforms_pool;
    const regretPct = (regret * 100).toFixed(1);
    document.getElementById('regret-alert').innerText =
      `Probability solo underperforms pool: ${regretPct}%`;

    document.getElementById('solo-results').innerHTML = `
      <div>Expected net: $${data.solo.expected_net_usd.toFixed(2)}</div>
      <div>P10 net: $${data.solo.p10_net_usd.toFixed(2)}</div>
      <div>P50 net: $${data.solo.p50_net_usd.toFixed(2)}</div>
      <div>P90 net: $${data.solo.p90_net_usd.toFixed(2)}</div>
      <div>Probability negative net: ${(data.solo.probability_negative_net*100).toFixed(1)}%</div>
      <div>Probability zero blocks: ${(data.solo.probability_zero_blocks*100).toFixed(1)}%</div>
    `;

    document.getElementById('pool-results').innerHTML = `
      <div>Expected net: $${data.pool.expected_net_usd.toFixed(2)}</div>
    `;

    resultsEl.style.display = 'block';
  }

  async function compute() {
    const payload = toPayload();

    // Your existing compare API endpoint.
    const res = await fetch('/api/v1/compare', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      let detail = '';
      try {
        const err = await res.json();
        detail = JSON.stringify(err, null, 2);
      } catch (_) {}
      alert(`Error computing comparison. HTTP ${res.status}\n\n${detail}`);
      return;
    }

    const data = await res.json();
    render(data);

    // Enable share button once we have a valid payload/results
    shareBtn.disabled = false;
    shareStatus.textContent = '';
  }

  async function share() {
    const payload = toPayload();

    // Share should use the JSON endpoint (returns {token, url})
    const res = await fetch('/api/compare/share', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      alert('Error creating share link.');
      return;
    }

    const data = await res.json();
    const url = `${window.location.origin}${data.url}`;

    try {
      await navigator.clipboard.writeText(url);
      shareStatus.textContent = 'Share link copied.';
      setTimeout(() => { shareStatus.textContent = ''; }, 1500);
    } catch (e) {
      window.prompt('Copy this link:', url);
    }
  }

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await compute();
    });
  }

  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      await share();
    });
  }

  // Token-mode render: server passed `result`
  {% if token_mode %}
  (function () {
    const data = {{ result|tojson }};
    if (data) {
      render(data);
      shareBtn.disabled = true;
      shareStatus.textContent = 'This page is already a share link.';
    }

    const copyBtn = document.getElementById('copy-existing');
    const copyStatus = document.getElementById('copy-existing-status');
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        const url = `${window.location.origin}/c/{{ token }}`;
        try {
          await navigator.clipboard.writeText(url);
          copyStatus.textContent = 'Copied.';
          setTimeout(() => { copyStatus.textContent = ''; }, 1500);
        } catch (e) {
          window.prompt('Copy this link:', url);
        }
      });
    }
  })();
  {% endif %}
})();
</script>

</body>
</html>